<!DOCTYPE html>
<html>
<head>
	<title>Fighting Game</title>
	<style>
		body {
			overflow: hidden;
			margin: 0px;
		}
	</style>
</head>
<body onLoad = requestAnimationFrame(start)>
<canvas></canvas>


<script>

    // Declare and initialize the canvas variables
    let canvas = document.querySelector('canvas');
    let ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    // Variables for finding FPS
    const times = [];
    let fps;

    // Add event listeners for keydown and keyup and change the array "keys" accordingly
    let keys = [];
    window.addEventListener('keydown', function (e) {
        keys[e.keyCode] = true;
    })
    window.addEventListener('keyup', function (e) {
        keys[e.keyCode] = false;
    })

    // Create state machine and initialize states
    gStateMachine = new StateMachine({
        start: new StartState(),
        play: new PlayState(),
        game_over: new GameOverState(),
        win: new WinState(),
        select: new SelectState(),
        });
    gStateMachine.change('start');

    function start(){
        gLevelMaker.generateLevel();
        update();
        draw();
    }

    /* 
    * The update function - called every frame using requestAnimationFrame and updates
    * individual parts of the game
    */
    function update(){
        if(keys[80] && pauseTimer < 0){
            if(!gSounds.main.paused)
                gSounds.main.pause();
            else
                gSounds.main.play();
            pauseTimer = 10;
        }
        pauseTimer--;
        gStateMachine.update();
        requestAnimationFrame(update);
    }

    /*
    * Draw on the canvas and call the render functions of other necessary parts
    */
    function draw(){ 
        //ctx.imageSmoothingEnabled = false; 
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        displayFPS();
        gStateMachine.render();
        requestAnimationFrame(draw);
    }

    /*
    * Display the FPS by adding a time stamp to the times array and removing any stamp
    * longer than one second
    */
    function displayFPS(){
        const now = performance.now();
        while (times.length > 0 && times[0] <= now - 1000) {
            times.shift();
        }
        times.push(now);
        fps = times.length;
        
        ctx.textAlign = 'left';
        //ctx.font = gFonts.small;
        ctx.fillStyle = 'blue';
        ctx.fillText("FPS: " + fps, 10*SCALE_FACTOR_WIDTH + cameraScroll, 10*SCALE_FACTOR_HEIGHT);
    }

    function randInt(min, max){
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min + 1) + min); 
    }

</script>

</body>
</html>